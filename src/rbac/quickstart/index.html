<!DOCTYPE html>
<html lang="en">
<head>

  <title>Getting Started with Access Control: CLI</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link href="/assets/styles/styles.css"    rel="stylesheet" type="text/css"  />
  <link href="/assets/styles/docstyles.css" rel="stylesheet" type="text/css" />
  <link href="/assets/styles/prettify.css"  rel="stylesheet" type="text/css" />
  <script src="/assets/js/prettify.js" type="text/javascript"></script>
  <script src="/assets/js/prettify.js" type="text/javascript"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>


    <script type="text/javascript">
      $(document).ready(function() {
          $('pre').each(function() {
              var thepre = $(this);
              if (thepre.hasClass('javascript') ||
                  thepre.hasClass('js') ||
                  thepre.hasClass('shell') ||
                  thepre.hasClass('bash')
                 )
                thepre.addClass('prettyprint');
          });
          prettyPrint();
      });
    </script>



</head>

<body>

  <div id="header">
      <div style="margin: 10px 10px">
        <p>
          Philip Borenstein: Writing sample <br/>
          This is a snapshot of this topic when I wrote it.<br/>
          You can find the current version in the
          <a href="http://docs.joyent.com">Joyent documentation.</p>
        </p>
      </div>
  </div>
  <div id="sidebar">
    <div class="menu">
      <form id="search" action="/search"><input type="search" name="q" placeholder="Search..."></form>
      
<ul>

  
	
	<li class="depth-1">

	<a href="/rbac">Role Based Access Control</a>

			
<ul>

  
	
	<li class="depth-2 hasChildren">

	<a class="active" href="/rbac/quickstart">Getting Started with Access Control: CLI</a>

			
<ul>

  
	
	<li class="depth-3">

	<a href="/rbac/quickstart/requirements">Getting the RBAC Tools</a>

			
	</li>

	
</ul>

	</li>

	
	<li class="depth-2">

	<a href="/rbac/portal">Getting Started with Access Control: Portal</a>

			
	</li>

	
	<li class="depth-2">

	<a href="/rbac/cloudapi">Using Access Control with CloudAPI</a>

			
	</li>

	
	<li class="depth-2">

	<a href="/rbac/users">Working with Users</a>

			
	</li>

	
	<li class="depth-2">

	<a href="/rbac/roles">Working with Roles</a>

			
	</li>

	
	<li class="depth-2">

	<a href="/rbac/policies">Working with Policies</a>

			
	</li>

	
	<li class="depth-2">

	<a href="/rbac/rules">Working with Rules</a>

			
	</li>

	
	<li class="depth-2">

	<a href="/rbac/underthehood">Under the Hood</a>

			
	</li>

	
</ul>

	</li>

	
</ul>
    </div>
        <div class="footblock">
    <p>Â© 2015 <a href="http://joyent.com">Joyent, Inc.</a> | <a href="mailto:&#115;&#x75;&#x70;&#112;&#111;&#x72;&#x74;&#64;&#106;&#x6f;&#x79;&#101;&#110;&#116;&#x2e;&#99;&#111;&#x6d;">Questions, comments, feeback.</a></p></div>
  </div>
<div id="content" class="content">
    <nav class="breadcrumb">
	<ul>
					<li><a href="/">Home &rsaquo;</a></li>
					<li><a href="/rbac">Role Based Access Control &rsaquo;</a></li>
			</ul>
</nav>    <h1>Getting Started with Access Control: CLI</h1>
    <div class="infoblock">
                
    <div class="stability_3 stability">
        Stability: <a href="/stability">Stable</a>
    </div>
    </div>
    <p>In this walkthrough
we'll demonstrate access control on Manta objects
using the command line interface.
If you haven't already,
be sure to read
the <a href="/rbac">RBAC overview</a>,
then come back here to continue.</p>
<p>To follow along
you will need to install the CloudAPI and Manta CLI tools.
See <a href="/rbac/quickstart/requirements">Getting the RBAC Tools</a>
to learn how to set up your environment.</p>
<h2>Overview</h2>
<p>Assume that we have a contractor named Maria.
We want to give her access to a single Manta object, <code>access.log</code>.
In this walkthrough you will learn about</p>
<ul>
<li>Creating a user</li>
<li>Adding an SSH key to the user</li>
<li>Creating a role to allow access to contractors</li>
<li>Creating a policy that allows access to Manta objects</li>
<li>Associating the policy with the role</li>
<li>Associating the role with the object</li>
<li>Finding out which roles are associated with an object</li>
<li>The difference between members and default members in roles</li>
</ul>
<p>Once that's done,
we'll modify the contractor role
to allow Maria to access the entire directory.</p>
<p>There are two Manta objects in the account.
The account owner always has unrestricted  access to all the objects.
All other users in the account need permission to access any objects.</p>
<pre><code>$ mls ~~/stor
access.log
readme.txt

$ mget -q ~~/stor/access.log | head
127.0.0.1 - - [11/Feb/2014:13:31:11 -0500] "GET / HTTP/1.1" 200 2158
127.0.0.1 - - [11/Feb/2014:13:31:18 -0500] "GET /search?q=linux HTTP/1.1" 200 2580
127.0.0.1 - - [11/Feb/2014:13:31:56 -0500] "GET /template HTTP/1.1" 200 7023
127.0.0.1 - - [11/Feb/2014:13:32:02 -0500] "GET /images/upgrading HTTP/1.1" 200 5992
127.0.0.1 - - [11/Feb/2014:13:32:10 -0500] "GET /images/search?q=linux HTTP/1.1" 404 1760
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /images/search?q=linux HTTP/1.1" 404 1760
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/styles.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/php.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/html.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/js.css HTTP/1.1" 304 -</code></pre>
<h2>Create a User</h2>
<p>Now, create the user <code>maria</code>.
When you create a user, you must provide</p>
<ul>
<li>a login name</li>
<li>a password</li>
<li>an email address</li>
</ul>
<pre><code>$ sdc-user create --login=maria --password=123secret --email=maria@example.com
{
  "id": "8e9fcc58-3240-4e33-d145-fad9d92c6822",
  "login": "maria",
  "email": "maria@example.com",
  "updated": "2014-07-17T15:32:48.029Z",
  "created": "2014-07-17T15:32:48.029Z"
}</code></pre>
<p>You can learn more about users in
<a href="/rbac/users">Working with Users</a>.</p>
<h2>Add an SSH key to the User</h2>
<p>Every user needs an SSH key.
Ideally, every user has their own SSH key.</p>
<pre><code>$ sdc-user upload-key 8e9fcc58-3240-4e33-d145-fad9d92c6822 --name=mariakey ~/.ssh/maria.pub
{
  "name": "mariakey",
  "fingerprint": "61:62:35:66:e6:e0:91:6a:fc:dc:d2:1b:90:52:51:04",
  "key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDLnrt...fMp maria@example.com\n"
}</code></pre>
<p>The new user, <code>maria</code>, has no access by default.
When she tries to list the Manta contents,
she gets an error.</p>
<pre><code>$ mls --user=maria --keyId=61:62:35:66:e6:e0:91:6a:fc:dc:d2:1b:90:52:51:04 ~~/stor
mls: NoMatchingRoleTagError: None of your active roles are present on the resource.</code></pre>
<h2>Create a Role</h2>
<p>We want to give Maria access to the object <code>access.log</code>.
First, create a role.
We'll call it <code>contractor</code>,
and make <code>maria</code> a member.</p>
<pre><code>$ sdc-role create --name=contractor --members=maria --default-members=maria
{
  "name": "contractor",
  "id": "559d4252-d75c-4189-bf08-f30c73a703a6",
  "members": [
    "maria"
  ],
  "default_members": [
    "maria"
  ],
  "policies": []
}</code></pre>
<p>Default members are users who can assume a role without specifying it.
Users who are not default members need to specify the role
when they access a resource.</p>
<p>You can learn more about roles in
<a href="/rbac/roles">Working with Roles</a>.</p>
<p>The new role has no policies,
so let's create that next.</p>
<h2>Create a Policy</h2>
<p>A policy is a named collection of rules.
Rules are written in the <a href="https://github.com/joyent/node-aperture">Aperture policy language </a>
which allows you write rules in a human readable form. Aperture rules are of the form</p>
<p><code>CAN &lt;action&gt;  IF &lt;condition&gt;</code></p>
<p>For this walkthrough,
we'll be using only two Manta actions,
and we will not be using the condition part of the rule.
See <a href="/rbac/rules">Working with Rules</a> to learn more about writing rules.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Rule</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">CAN getobject</td>
<td style="text-align: left;">Read a Manta object</td>
</tr>
<tr>
<td style="text-align: left;">CAN getdirectory</td>
<td style="text-align: left;">List a Manta directory</td>
</tr>
</tbody>
</table>
<p>We now create a new policy named <code>read</code>.
It has one rule
that allows a user to get a Manta object.</p>
<pre><code>$ sdc-policy create --name=read --rules='CAN getobject'
{
  "name": "read",
  "id": "3072e003-34f7-c4a5-9f73-a8808de40e26",
  "rules": [
    "CAN getobject"
  ]
}</code></pre>
<p>You can learn more about policies in
<a href="/rbac/policies">Working with Policies</a>,
and you can learn about the available rules in
<a href="/rbac/rules">Working with Rules</a>.</p>
<h2>Associate the Policy with the Role</h2>
<p>Now we can add the <code>read</code> policy to the <code>contractor</code> role.</p>
<pre><code>$ sdc-role update 559d4252-d75c-4189-bf08-f30c73a703a6 --policies=read
{
  "name": "contractor",
  "id": "559d4252-d75c-4189-bf08-f30c73a703a6",
  "members": [
    "maria"
  ],
  "default_members": [
    "maria"
  ],
  "policies": [
    "read"
  ]
}</code></pre>
<h2>Associate the Role with the Object</h2>
<p>The final step is to associate the role with an object.
For Manta objects, use the <code>mchmod</code> command.</p>
<pre><code>$ mchmod +contractor  ~~/stor/access.log</code></pre>
<p>Maria still can't list the contents of <code>~~/stor</code>.</p>
<pre><code>$ mls --user=maria --keyId=61:62:35:66:e6:e0:91:6a:fc:dc:d2:1b:90:52:51:04 ~~/stor
mls: NoMatchingRoleTagError: None of your active roles are present on the resource.</code></pre>
<p>But she can get the contents of <code>access.log</code>.</p>
<pre><code>$ mget -q --user=maria --keyId=61:62:35:66:e6:e0:91:6a:fc:dc:d2:1b:90:52:51:04 ~~/stor/access.log | head
127.0.0.1 - - [11/Feb/2014:13:31:11 -0500] "GET / HTTP/1.1" 200 2158
127.0.0.1 - - [11/Feb/2014:13:31:18 -0500] "GET /search?q=linux HTTP/1.1" 200 2580
127.0.0.1 - - [11/Feb/2014:13:31:56 -0500] "GET /template HTTP/1.1" 200 7023
127.0.0.1 - - [11/Feb/2014:13:32:02 -0500] "GET /images/upgrading HTTP/1.1" 200 5992
127.0.0.1 - - [11/Feb/2014:13:32:10 -0500] "GET /images/search?q=linux HTTP/1.1" 404 1760
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /images/search?q=linux HTTP/1.1" 404 1760
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/styles.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/php.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/html.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/js.css HTTP/1.1" 304 -</code></pre>
<h2>Getting Access Information about an Object</h2>
<p>To find out which roles are associated with a Manta object,
use the <code>minfo</code> command.</p>
<pre><code>$ minfo ~~/stor/access.log
HTTP/1.1 200 OK
etag: b08c37e1-2878-c45a-8858-840810d5fe88
last-modified: Thu, 17 Jul 2014 15:46:15 GMT
role-tag: contractor
durability-level: 2
content-length: 495222
content-md5: ZJMsN0NiqW15Tbih7yKKlg==
content-type: text/plain
date: Thu, 17 Jul 2014 16:10:17 GMT
server: Manta
x-request-id: 0c2f74a9-1263-4654-89b0-4031206343b2
x-response-time: 27
x-server-name: 204ac483-7e7e-4083-9ea2-c9ea22f459fd
connection: keep-alive</code></pre>
<h2>Adding a New Policy to a Role</h2>
<p>We want to let Maria list the contents of <code>~~/stor</code>,
so we create a new policy named <code>list</code>
that allows access to directory contents.</p>
<pre><code>$ sdc-policy create --name=list --rules='CAN getdirectory'
{
  "name": "list",
  "id": "616b8f9b-9260-e34d-fcbf-f6dba02a6512",
  "rules": [
    "CAN getdirectory"
  ]
}</code></pre>
<p>Now we add the <code>list</code> policy to the <code>contractor</code> role.
You have to name all the policies.
<code>sdc-role update</code> replaces the existing policies
with the ones you specify.</p>
<pre><code>$ sdc-role update 559d4252-d75c-4189-bf08-f30c73a703a6 --policies=list --policies=read
{
  "name": "contractor",
  "id": "559d4252-d75c-4189-bf08-f30c73a703a6",
  "members": [
    "maria"
  ],
  "default_members": [
    "maria"
  ],
  "policies": [
    "read",
    "list"
  ]
}</code></pre>
<p>We have to associate the <code>contractor</code> role with <code>~~/stor</code>.</p>
<pre><code>$ mchmod +contractor ~~/stor</code></pre>
<p>Now Maria can list the entire directory,
but she only has access to <code>access.log</code>.</p>
<pre><code>$ mls --user=maria --keyId=61:62:35:66:e6:e0:91:6a:fc:dc:d2:1b:90:52:51:04 ~~/stor
access.log
readme.txt

$ mget -q --user=maria --keyId=61:62:35:66:e6:e0:91:6a:fc:dc:d2:1b:90:52:51:04 ~~/stor/readme.txt
mget: NoMatchingRoleTagError: None of your active roles are present on the resource.</code></pre>
<h2>Members vs Default Members</h2>
<p>A role has two lists of members.
The default members list are users who assume the role automatically.
Users on the members list must specify the role explicitly.</p>
<p>For example, we add the user <code>jill</code> to the <code>contractors</code> member list
but not to the default members list.</p>
<pre><code>$ sdc-role update 559d4252-d75c-4189-bf08-f30c73a703a6 --members=maria --members=jill
{
  "name": "contractor",
  "id": "559d4252-d75c-4189-bf08-f30c73a703a6",
  "members": [
    "maria",
    "jill"
  ],
  "default_members": [
    "maria"
  ],
  "policies": [
    "read",
    "list"
  ]
}</code></pre>
<p>Now if Jill tries to get <code>access.log</code>, she gets an error.</p>
<pre><code>$ mget -q --user=jill --keyId=10:d0:59:ef:4f:71:3b:8b:4b:6a:05:d2:57:24:28:27 ~~/stor/access.log | head
mget: NoMatchingRoleTagError: None of your active roles are present on the resource.</code></pre>
<p>But if she explicitly assumes the <code>contractor</code> role, she can read the object.</p>
<pre><code>$ mget -q --role=contractor --user=jill --keyId=10:d0:59:ef:4f:71:3b:8b:4b:6a:05:d2:57:24:28:27 ~~/stor/access.log | head
127.0.0.1 - - [11/Feb/2014:13:31:11 -0500] "GET / HTTP/1.1" 200 2158
127.0.0.1 - - [11/Feb/2014:13:31:18 -0500] "GET /search?q=linux HTTP/1.1" 200 2580
127.0.0.1 - - [11/Feb/2014:13:31:56 -0500] "GET /template HTTP/1.1" 200 7023
127.0.0.1 - - [11/Feb/2014:13:32:02 -0500] "GET /images/upgrading HTTP/1.1" 200 5992
127.0.0.1 - - [11/Feb/2014:13:32:10 -0500] "GET /images/search?q=linux HTTP/1.1" 404 1760
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /images/search?q=linux HTTP/1.1" 404 1760
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/styles.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/php.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/html.css HTTP/1.1" 304 -
127.0.0.1 - - [11/Feb/2014:13:32:11 -0500] "GET /assets/styles/js.css HTTP/1.1" 304 -</code></pre></div>
<div style="clear:both"></div>
</body>

</html>
